#!/bin/bash

# å®‰è£…å¿…è¦ä¾èµ–
function install_royal_tools() {
    echo "ğŸ“¦ å®‰è£…çš‡å®¶ä¾èµ–ä¸­..." >&2
    if ! command -v jq &>/dev/null; then
        apt-get install -y jq || yum install -y jq
    fi
    if ! command -v whois &>/dev/null; then
        apt-get install -y whois || yum install -y whois
    fi
}

# åˆå§‹åŒ–JSONè¾“å‡º
function init_json() {
    echo '{
        "metadata": {
            "script": "çš‡å®¶æœåŠ¡å™¨å·¡æ£€å¤§å…¸ v5.0",
            "timestamp": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'"
        },
        "tests": {}
    }'
}

# æ›´æ–°JSONç»“æœ
function update_json() {
    jq --argjson new "$1" '.tests += $new'
}

# IPè´¨é‡æ£€æµ‹
function ip_quality_check() {
    local ip=$(curl -s ifconfig.me)
    local asn_info=$(whois -h whois.cymru.com " -v $ip" | tail -n 1)
    local asn_number=$(echo "$asn_info" | awk '{print $1}')
    local asn_org=$(echo "$asn_info" | awk -F'|' '{print $3}' | sed 's/^ *//;s/ *$//')

    jq -n --arg ip "$ip" \
        --arg asn "$asn_number" \
        --arg org "$asn_org" \
        '{
            "ip_quality": {
                "ip": $ip,
                "asn": $asn,
                "organization": $org,
                "is_datacenter": (if ($org | test("Amazon|Google|Microsoft|Cloudflare")) then true else false end),
                "blacklist_check": {
                    "spamhaus": (if ("'$(curl -s "https://check.spamhaus.org/api?ip=$ip" | grep -c "LISTED")'" == "1") then true else false end
                }
            }
        }'
}

# æµåª’ä½“æ£€æµ‹
function streaming_test() {
    local json=$(curl -sSL "https://netflix-api.xyglab.cc/check?ip=$(curl -s ifconfig.me)")
    jq -n \
        --argjson netflix "$(jq '{netflix: .netflix, region: .netflix_region}' <<< "$json")" \
        --argjson disney "$(jq '{disney: .disney}' <<< "$json")" \
        --argjson tiktok "$(jq '{tiktok: .tiktok}' <<< "$json")" \
        '{
            "streaming": {
                "netflix": $netflix,
                "disney_plus": $disney,
                "tiktok": $tiktok
            }
        }'
}

# ä¸»ç¨‹åº
install_royal_tools
OUTPUT=$(init_json)

# æ‰§è¡Œæ£€æµ‹å¹¶åˆå¹¶JSON
IP_JSON=$(ip_quality_check)
OUTPUT=$(jq --argjson ip "$IP_JSON" '.tests += $ip' <<< "$OUTPUT")

STREAM_JSON=$(streaming_test)
OUTPUT=$(jq --argjson stream "$STREAM_JSON" '.tests += $stream' <<< "$OUTPUT")

# è¾“å‡ºç¾åŒ–åçš„JSON
echo "$OUTPUT" | jq .
